## ---------------------------
##
## Script name: imputation.R
##
## Purpose of script: 
##      To do imputation for the item missingness in the pre-cleaned SOL and MxFLS data.
##
## Author: Cal Chengqi Fang
##
## Date Created: 2023-07-31
##
## Copyright (c) Cal Chengqi Fang, 2023
## Email: cal.cf@uchicago.edu
##
## ---------------------------
##
## Notes:
##      The method used is multiple imputation with MICE package. As there were variables 
##      in the original data that were derivatives of original variables, we would only run 
##      imputation on original variables to avoid logic conflict.
## 
## ---------------------------

## set working directory for Mac and PC
setwd("/Users/atchoo/Documents/GitHub/SOL-MXFLS")  # Cal's working directory (mac)
# setwd("C:/Users/")     # Cal's working directory (PC)

## ---------------------------

rm(list=ls())
options(scipen=6, digits=4)             # I prefer to view outputs in non-scientific notation
memory.limit(30000000)                  # this is needed on some PCs to increase memory allowance, but has no impact on macs.

## ---------------------------

## load up the packages

require(tidyverse)
require(data.table)
require(mice)
require(howManyImputations)

## ---------------------------
# STEP 1
# Read in the data
load("data/SOL_MxFLS_cleaned.RData")

# Select out all original variables that should be imputed
SOL_prep <- SOL %>% 
  select(c("age", "male", "edu_hs", "employ_cat", "marital_rc", "migstatus", "homeown", "insurance", "income", "sesladder_now", # "yrsus",
           "srh_rc", "cancer_self",  "heart_self", "diabetes_self", "hypertension_self", 
           "smoker", "physical_activity",
           "total_chol", "hdl_chol", "systolic", "diastolic", "hba1c", "height_cm", "weight_kg", "hip_cm", "waist_cm",
           "strat", "cohort", 
           "expan_fac"))


# STEP 2
# Run Little's MCAR test
## The low p-value implies that this data is not missing completely at random
naniar::mcar_test(SOL_prep %>% 
                    select(-c("expan_fac", "cohort", "strat", "cohort")))

# Examine the missingness pattern
md.pattern(SOL_prep, rotate.names=TRUE)

# Quickly check the missingness pattern for these variables
# Four variables were identified with missingness rate higher than 15% 
over15 <- SOL_prep %>% 
  finalfit::ff_glimpse()
over15 <- over15$Continuous %>% 
  filter(as.numeric(missing_percent) >= 15)
# Variables with missing proportion exceeding 15% cannot be imputed with MICE so have to dropped
# However, different from MxFLS, SOL has no such variable so nothing needed to be done here


# STEP 3
# Specify imputation model choices for variables of interest 
continuous <- c("sesladder_now",
                "systolic", "diastolic", "height_cm", "weight_kg", "hip_cm", "waist_cm")
binary <- c("edu_hs", "marital_rc", "homeown", "insurance", 
            "smoker", "physical_activity", 
            "srh_rc", "cancer_self", "hypertension_self", "heart_self", "diabetes_self")
categorical <- c("employ_cat")
null <- c("age", "male", "migstatus", "expan_fac", "strat", "cohort")

# Transform all non-numeric variables in SOL_prep to factor
SOL_prep <- SOL_prep %>%
  mutate(across(all_of(binary), as.factor)) %>%
  mutate(across(all_of(categorical), as.factor)) %>% 
  mutate(male = as.factor(male),
         migstatus = as.factor(migstatus),
         strat = as.factor(strat),
         cohort = as.factor(cohort))

# Sudo-MI to grab predictor matrix
imp <- mice(SOL_prep, maxit=0)

# Extract predictor matrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Specify imputation models for different groups of variable
## Continuous variable - PMM
meth[continuous] <- "pmm"
## Dichotomous variable - Logit model
meth[binary] <- "logreg"
## Unordered categorical variable - Multinomial model
meth[categorical] <- "polyreg"
## age and male have no missingness so no need to be imputed
## strat, cohort, and center are added to improve the imputation performance but do not need to be imputed
meth[null] <- ""
  
# Run MICE
imp_SOL <- mice(SOL_prep %>% 
                  labelled::remove_val_labels(),
                m=20,
                maxit=20, 
                predictorMatrix=predM, 
                method=meth, print=FALSE,
                seed=20230801)


# STEP 4
plot(imp_SOL)
# Check on the logged events
## It seems like the raised issue is simply the missingness of the two other factor level from each dataset
## and no issue raised from the model choice so at this point the result seems legit
imp_SOL$loggedEvents

save(SOL, imp_SOL, file="data/SOL_imputed.RData")

